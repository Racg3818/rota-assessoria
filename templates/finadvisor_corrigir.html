{% extends "base.html" %}
{% block title %}Corrigir códigos — Rota Assessoria{% endblock %}
{% block subtitle %}Linhas de receita cujo cliente_codigo contém {{ codigo_xp }}{% endblock %}
{% block content %}

<div class="flex items-center justify-between px-2 py-4 ">

	<a href="{{ url_for('finadvisor.index') }}" class="px-3 py-3 rounded border text-sm hover:bg-gray-50">← Voltar</a>

</div>

<div class="mb-4 text-xs text-gray-600">
  <span class="px-2 py-1 rounded border bg-white">Total encontrado: {{ total }}</span>
</div>

<div class="border rounded-xl overflow-x-auto bg-white">
  <table class="min-w-full text-sm">
    <thead class="bg-gray-50 text-gray-600">
      <tr>       
        <th class="text-left px-3 py-2">Data ref</th>        
        <th class="text-left px-3 py-2">Cliente (código)</th>        
        <th class="text-left px-3 py-2">Família</th>
        <th class="text-left px-3 py-2">Produto</th>
        <th class="text-left px-3 py-2">Detalhe</th>
        <th class="text-right px-3 py-2">Valor bruto</th>        
        <th class="text-right px-3 py-2">Valor líquido</th>        
        <th class="text-right px-3 py-2">Comissão líquida</th>
        <th class="text-right px-3 py-2">Comissão escritório</th>
        <th class="text-left px-3 py-2 w-64">Novo cliente_codigo</th>        
      </tr>
    </thead>
    <tbody>
      {% if rows %}
        {% for r in rows %}
          <tr class="border-t align-top">            
            <td class="px-3 py-2">{{ r.data_ref }}</td>            
            <td class="px-3 py-2">{{ r.cliente_codigo or '—' }}</td>            
            <td class="px-3 py-2">{{ r.familia or '—' }}</td>
            <td class="px-3 py-2">{{ r.produto or '—' }}</td>
            <td class="px-3 py-2">{{ r.detalhe or '—' }}</td>
            <td class="px-3 py-2 text-right">{{ r.valor_bruto or 0 }}</td>            
            <td class="px-3 py-2 text-right">{{ r.valor_liquido or 0 }}</td>            
            <td class="px-3 py-2 text-right">{{ r.comissao_liquida or 0 }}</td>
            <td class="px-3 py-2 text-right">{{ r.comissao_escritorio or 0 }}</td>

            <td class="px-3 py-2">
              <form method="post" action="{{ url_for('finadvisor.corrigir_codigos_update', item_id=r.id) }}"
                    class="flex items-center gap-2">
                <input type="text" name="novo_codigo" placeholder="novo código"
                       class="border rounded px-2 py-1 text-sm w-40" required />
                <!-- passamos também o antigo e o nome para sincronismo em receita_clientes -->
                <input type="hidden" name="antigo_codigo" value="{{ r.cliente_codigo or '' }}">
                <input type="hidden" name="cliente_nome" value="{{ r.cliente_nome or '' }}">
                <button class="px-2 py-1 rounded bg-gray-900 text-white text-sm">Salvar</button>
              </form>
            </td>            
          </tr>
        {% endfor %}
      {% else %}
        <tr class="border-t">
          <td colspan="16" class="px-3 py-4 text-gray-500">Nenhum registro encontrado.</td>
        </tr>
      {% endif %}
    </tbody>
  </table>
</div>

<div class="flex items-center justify-between mt-4">
  
  <div class="flex items-center gap-2">
    {% if page > 1 %}
      <a href="{{ url_for('finadvisor.corrigir_codigos_list', page=page-1, page_size=page_size) }}"
         class="px-3 py-2 rounded border text-sm hover:bg-gray-50">Anterior</a>
    {% endif %}
    {% if (page * page_size) < total %}
      <a href="{{ url_for('finadvisor.corrigir_codigos_list', page=page+1, page_size=page_size) }}"
         class="px-3 py-2 rounded border text-sm hover:bg-gray-50">Próxima</a>
    {% endif %}
  </div>
</div>

{% endblock %}
