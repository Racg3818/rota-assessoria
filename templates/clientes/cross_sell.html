{% extends "base.html" %}
{% block title %}Cross Sell ‚Äî Rota Assessoria{% endblock %}
{% block subtitle %}Gest√£o de Apresenta√ß√£o de Produtos{% endblock %}
{% block content %}

<!-- Header Moderno -->
<div class="relative mb-8 bg-gradient-to-br from-green-600 via-teal-600 to-cyan-700 rounded-3xl p-6 text-white overflow-hidden">
  <div class="absolute inset-0 opacity-10">
    <div class="absolute top-0 -left-4 w-64 h-64 bg-white rounded-full mix-blend-multiply filter blur-xl animate-pulse"></div>
    <div class="absolute top-0 -right-4 w-64 h-64 bg-teal-300 rounded-full mix-blend-multiply filter blur-xl animate-pulse animation-delay-2000"></div>
  </div>

  <div class="relative z-10">
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
      <div>
        <div class="flex items-center gap-3 mb-2">
          <div class="w-10 h-10 bg-white/20 rounded-xl flex items-center justify-center">
            <span class="text-xl">üéØ</span>
          </div>
          <h1 class="text-2xl md:text-3xl font-bold text-white">Cross Sell</h1>
        </div>
        <p class="text-teal-100 text-sm md:text-base">Gerencie a apresenta√ß√£o de produtos aos clientes</p>
      </div>

      <div class="flex flex-wrap gap-2">
        <a href="{{ url_for('clientes.index') }}"
           class="px-4 py-2 bg-white/10 hover:bg-white/20 text-white rounded-xl text-sm font-medium transition-colors border border-white/20 backdrop-blur-sm">
          ‚Üê Voltar para Clientes
        </a>
        <a href="{{ url_for('clientes.insights') }}"
           class="px-4 py-2 bg-white text-teal-700 rounded-xl text-sm font-bold hover:bg-gray-50 transition-colors shadow-lg">
          üí° Ver Insights
        </a>
      </div>
    </div>
  </div>
</div>

<!-- Legenda de Status -->
<div class="mb-6 bg-white rounded-xl border p-4">
  <div class="flex items-center gap-2 mb-3">
    <span class="text-lg">‚ÑπÔ∏è</span>
    <h3 class="font-medium text-gray-800">Legenda de Status</h3>
  </div>
  <div class="flex flex-wrap gap-4 text-sm">
    <div class="flex items-center gap-2">
      <div class="w-4 h-4 rounded bg-gray-200"></div>
      <span class="text-gray-700"><strong>Em branco:</strong> N√£o iniciado</span>
    </div>
    <div class="flex items-center gap-2">
      <div class="w-4 h-4 rounded bg-blue-500"></div>
      <span class="text-gray-700"><strong>Apresentado:</strong> Cliente conhece o produto</span>
    </div>
    <div class="flex items-center gap-2">
      <div class="w-4 h-4 rounded bg-green-500"></div>
      <span class="text-gray-700"><strong>Boletado:</strong> Cliente contratou</span>
    </div>
  </div>
</div>

<!-- Filtro Alfab√©tico -->
{% if letras_ordenadas %}
<div class="mb-6 bg-white rounded-xl border p-4">
  <div class="flex items-center gap-2 mb-3">
    <span class="text-lg">üî§</span>
    <h3 class="font-medium text-gray-800">Filtrar por Letra</h3>
  </div>

  <div class="flex flex-wrap gap-2">
    <a href="{{ url_for('clientes.cross_sell', q=filtros.q or '') }}"
       class="px-3 py-2 rounded-lg text-sm font-medium transition-colors
              {% if not filtros.letra %}bg-teal-500 text-white{% else %}bg-gray-100 text-gray-700 hover:bg-gray-200{% endif %}">
      Todos
    </a>

    {% for letra in letras_ordenadas %}
    <a href="{{ url_for('clientes.cross_sell', q=filtros.q or '', letra=letra) }}"
       class="px-3 py-2 rounded-lg text-sm font-medium transition-colors min-w-[40px] text-center
              {% if filtros.letra == letra %}bg-teal-500 text-white{% else %}bg-gray-100 text-gray-700 hover:bg-gray-200{% endif %}">
      {{ letra }}
    </a>
    {% endfor %}
  </div>
</div>
{% endif %}

<!-- Filtro de Busca -->
<form method="get" class="mb-6">
  {% if filtros.letra %}
  <input type="hidden" name="letra" value="{{ filtros.letra }}">
  {% endif %}

  <div class="flex gap-3 items-end">
    <div class="flex-1">
      <label class="block text-xs text-gray-600 mb-1">Buscar por Nome</label>
      <input
        name="q"
        value="{{ filtros.q|default('', true) }}"
        placeholder="Digite o nome do cliente..."
        class="w-full border rounded-lg px-4 py-2 text-sm"
      />
    </div>
    <button type="submit" class="px-4 py-2 bg-teal-600 text-white rounded-lg hover:bg-teal-700 transition-colors">
      üîç Buscar
    </button>
  </div>
</form>

<!-- Tabela de Cross Sell -->
<div class="bg-white rounded-xl border overflow-hidden">
  <div class="overflow-x-auto">
    <table class="min-w-full divide-y divide-gray-200">
      <thead class="bg-gray-50">
        <tr>
          <th class="px-4 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider sticky left-0 bg-gray-50">
            Cliente
          </th>
          <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
            Fee Based
          </th>
          <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
            Financial Planning
          </th>
          <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
            MB
          </th>
          <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
            Offshore
          </th>
          <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
            Produto Estruturado
          </th>
          <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
            Asset
          </th>
          <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
            Seguro de Vida
          </th>
          <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
            Cons√≥rcio
          </th>
          <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
            Wealth
          </th>
          <th class="px-4 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">
            A√ß√µes
          </th>
        </tr>
      </thead>
      <tbody class="bg-white divide-y divide-gray-200">
        {% if clientes_cross_sell %}
          {% for cliente in clientes_cross_sell %}
          <tr class="hover:bg-gray-50 transition-colors" id="row-{{ cliente.id }}">
            <td class="px-4 py-3 text-sm font-medium text-gray-900 sticky left-0 bg-white">
              {{ cliente.nome }}
            </td>

            <td class="px-4 py-3 text-center">
              <select id="fee_based_{{ cliente.id }}" class="status-select border rounded px-2 py-1 text-xs" data-cliente-id="{{ cliente.id }}" data-field="fee_based">
                <option value="" {% if cliente.fee_based == '' %}selected{% endif %}></option>
                <option value="Apresentado" {% if cliente.fee_based == 'Apresentado' %}selected{% endif %}>Apresentado</option>
                <option value="Boletado" {% if cliente.fee_based == 'Boletado' %}selected{% endif %}>Boletado</option>
              </select>
            </td>

            <td class="px-4 py-3 text-center">
              <select id="financial_planning_{{ cliente.id }}" class="status-select border rounded px-2 py-1 text-xs" data-cliente-id="{{ cliente.id }}" data-field="financial_planning">
                <option value="" {% if cliente.financial_planning == '' %}selected{% endif %}></option>
                <option value="Apresentado" {% if cliente.financial_planning == 'Apresentado' %}selected{% endif %}>Apresentado</option>
                <option value="Boletado" {% if cliente.financial_planning == 'Boletado' %}selected{% endif %}>Boletado</option>
              </select>
            </td>

            <td class="px-4 py-3 text-center">
              <select id="mb_{{ cliente.id }}" class="status-select border rounded px-2 py-1 text-xs" data-cliente-id="{{ cliente.id }}" data-field="mb">
                <option value="" {% if cliente.mb == '' %}selected{% endif %}></option>
                <option value="Apresentado" {% if cliente.mb == 'Apresentado' %}selected{% endif %}>Apresentado</option>
                <option value="Boletado" {% if cliente.mb == 'Boletado' %}selected{% endif %}>Boletado</option>
              </select>
            </td>

            <td class="px-4 py-3 text-center">
              <select id="offshore_{{ cliente.id }}" class="status-select border rounded px-2 py-1 text-xs" data-cliente-id="{{ cliente.id }}" data-field="offshore">
                <option value="" {% if cliente.offshore == '' %}selected{% endif %}></option>
                <option value="Apresentado" {% if cliente.offshore == 'Apresentado' %}selected{% endif %}>Apresentado</option>
                <option value="Boletado" {% if cliente.offshore == 'Boletado' %}selected{% endif %}>Boletado</option>
              </select>
            </td>

            <td class="px-4 py-3 text-center">
              <select id="produto_estruturado_{{ cliente.id }}" class="status-select border rounded px-2 py-1 text-xs" data-cliente-id="{{ cliente.id }}" data-field="produto_estruturado">
                <option value="" {% if cliente.produto_estruturado == '' %}selected{% endif %}></option>
                <option value="Apresentado" {% if cliente.produto_estruturado == 'Apresentado' %}selected{% endif %}>Apresentado</option>
                <option value="Boletado" {% if cliente.produto_estruturado == 'Boletado' %}selected{% endif %}>Boletado</option>
              </select>
            </td>

            <td class="px-4 py-3 text-center">
              <select id="asset_{{ cliente.id }}" class="status-select border rounded px-2 py-1 text-xs" data-cliente-id="{{ cliente.id }}" data-field="asset">
                <option value="" {% if cliente.asset == '' %}selected{% endif %}></option>
                <option value="Apresentado" {% if cliente.asset == 'Apresentado' %}selected{% endif %}>Apresentado</option>
                <option value="Boletado" {% if cliente.asset == 'Boletado' %}selected{% endif %}>Boletado</option>
              </select>
            </td>

            <td class="px-4 py-3 text-center">
              <select id="seguro_vida_{{ cliente.id }}" class="status-select border rounded px-2 py-1 text-xs" data-cliente-id="{{ cliente.id }}" data-field="seguro_vida">
                <option value="" {% if cliente.seguro_vida == '' %}selected{% endif %}></option>
                <option value="Apresentado" {% if cliente.seguro_vida == 'Apresentado' %}selected{% endif %}>Apresentado</option>
                <option value="Boletado" {% if cliente.seguro_vida == 'Boletado' %}selected{% endif %}>Boletado</option>
              </select>
            </td>

            <td class="px-4 py-3 text-center">
              <select id="consorcio_{{ cliente.id }}" class="status-select border rounded px-2 py-1 text-xs" data-cliente-id="{{ cliente.id }}" data-field="consorcio">
                <option value="" {% if cliente.consorcio == '' %}selected{% endif %}></option>
                <option value="Apresentado" {% if cliente.consorcio == 'Apresentado' %}selected{% endif %}>Apresentado</option>
                <option value="Boletado" {% if cliente.consorcio == 'Boletado' %}selected{% endif %}>Boletado</option>
              </select>
            </td>

            <td class="px-4 py-3 text-center">
              <select id="wealth_{{ cliente.id }}" class="status-select border rounded px-2 py-1 text-xs" data-cliente-id="{{ cliente.id }}" data-field="wealth">
                <option value="" {% if cliente.wealth == '' %}selected{% endif %}></option>
                <option value="Apresentado" {% if cliente.wealth == 'Apresentado' %}selected{% endif %}>Apresentado</option>
                <option value="Boletado" {% if cliente.wealth == 'Boletado' %}selected{% endif %}>Boletado</option>
              </select>
            </td>

            <td class="px-4 py-3 text-center">
              <button onclick="salvarCrossSell('{{ cliente.id }}')" class="px-3 py-1 bg-teal-600 text-white text-xs rounded hover:bg-teal-700 transition-colors">
                üíæ Salvar
              </button>
            </td>
          </tr>
          {% endfor %}
        {% else %}
          <tr>
            <td colspan="11" class="px-4 py-8 text-center text-gray-500">
              Nenhum cliente encontrado.
            </td>
          </tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</div>

<style>
  .status-select {
    min-width: 100px;
  }
  .status-select option[value=""] {
    background-color: #f3f4f6;
  }
  .status-select option[value="Apresentado"] {
    background-color: #dbeafe;
  }
  .status-select option[value="Boletado"] {
    background-color: #d1fae5;
  }
</style>

<script>
function salvarCrossSell(clienteId) {
  const form = document.createElement('form');
  form.method = 'POST';
  form.action = '{{ url_for("clientes.salvar_cross_sell") }}';

  // Adicionar CSRF token se necess√°rio
  const csrfInput = document.createElement('input');
  csrfInput.type = 'hidden';
  csrfInput.name = 'csrf_token';
  csrfInput.value = '{{ csrf_token() if csrf_token else "" }}';
  form.appendChild(csrfInput);

  // Adicionar cliente_id
  const clienteInput = document.createElement('input');
  clienteInput.type = 'hidden';
  clienteInput.name = 'cliente_id';
  clienteInput.value = clienteId;
  form.appendChild(clienteInput);

  // Coletar todos os valores dos selects
  const fields = ['fee_based', 'financial_planning', 'mb', 'offshore', 'produto_estruturado', 'asset', 'seguro_vida', 'consorcio', 'wealth'];

  fields.forEach(field => {
    const select = document.getElementById(`${field}_${clienteId}`);
    if (select) {
      const input = document.createElement('input');
      input.type = 'hidden';
      input.name = field;
      input.value = select.value;
      form.appendChild(input);
    }
  });

  document.body.appendChild(form);
  form.submit();
}

// Aplicar cores aos selects baseado no valor selecionado
document.addEventListener('DOMContentLoaded', function() {
  const selects = document.querySelectorAll('.status-select');

  function updateSelectStyle(select) {
    const value = select.value;
    select.classList.remove('bg-gray-100', 'bg-blue-100', 'bg-green-100');

    if (value === '') {
      select.classList.add('bg-gray-100');
    } else if (value === 'Apresentado') {
      select.classList.add('bg-blue-100');
    } else if (value === 'Boletado') {
      select.classList.add('bg-green-100');
    }
  }

  selects.forEach(select => {
    updateSelectStyle(select);
    select.addEventListener('change', function() {
      updateSelectStyle(this);
    });
  });
});
</script>

{% endblock %}