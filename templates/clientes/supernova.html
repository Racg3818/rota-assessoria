{% extends "base.html" %}
{% block title %}Supernova — Clientes — Rota Assessoria{% endblock %}
{% block subtitle %}Data da última supernova por cliente{% endblock %}
{% block content %}

<!-- Header Supernova -->
<div class="relative mb-8 bg-gradient-to-br from-orange-500 via-red-500 to-pink-600 rounded-3xl p-6 text-white overflow-hidden">
  <!-- Background Pattern -->
  <div class="absolute inset-0 opacity-10">
    <div class="absolute top-0 -left-4 w-64 h-64 bg-white rounded-full mix-blend-multiply filter blur-xl animate-pulse"></div>
    <div class="absolute top-0 -right-4 w-64 h-64 bg-yellow-300 rounded-full mix-blend-multiply filter blur-xl animate-pulse animation-delay-2000"></div>
  </div>

  <div class="relative z-10">
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
      <div>
        <div class="flex items-center gap-3 mb-2">
          <div class="w-10 h-10 bg-white/20 rounded-xl flex items-center justify-center">
            <span class="text-xl">⭐</span>
          </div>
          <h1 class="text-2xl md:text-3xl font-bold text-white">Supernova</h1>
        </div>
        <p class="text-orange-100 text-sm md:text-base">Acompanhe a data da última supernova por cliente</p>
      </div>

      <!-- Voltar para Clientes -->
      <div class="flex flex-wrap gap-2">
        <a href="{{ url_for('clientes.index') }}"
           class="px-4 py-2 bg-white/10 hover:bg-white/20 text-white rounded-xl text-sm font-medium transition-colors border border-white/20 backdrop-blur-sm">
          ← Voltar aos Clientes
        </a>
      </div>
    </div>
  </div>
</div>

<!-- Filtro Alfabético -->
{% if letras_ordenadas %}
<div class="mb-6 bg-white rounded-xl border p-4">
  <div class="flex items-center gap-2 mb-3">
    <span class="text-lg">🔤</span>
    <h3 class="font-medium text-gray-800">Filtrar por Letra</h3>
  </div>

  <div class="flex flex-wrap gap-2">
    <!-- Botão "Todos" -->
    <a href="{{ url_for('clientes.supernova') }}"
       class="px-3 py-2 rounded-lg text-sm font-medium transition-colors
              {% if not filtros.letra %}bg-orange-500 text-white{% else %}bg-gray-100 text-gray-700 hover:bg-gray-200{% endif %}">
      Todos
    </a>

    <!-- Letras disponíveis -->
    {% for letra in letras_ordenadas %}
    <a href="{{ url_for('clientes.supernova', letra=letra) }}"
       class="px-3 py-2 rounded-lg text-sm font-medium transition-colors min-w-[40px] text-center
              {% if filtros.letra == letra %}bg-orange-500 text-white{% else %}bg-gray-100 text-gray-700 hover:bg-gray-200{% endif %}">
      {{ letra }}
    </a>
    {% endfor %}
  </div>

  {% if filtros.letra %}
  <div class="mt-2 text-sm text-gray-600">
    Mostrando clientes que começam com "<strong>{{ filtros.letra }}</strong>"
  </div>
  {% endif %}
</div>
{% endif %}

<!-- Filtros Avançados -->
<form method="get" class="mb-6">
  <!-- Input hidden para preservar filtro por letra -->
  {% if filtros.letra %}
  <input type="hidden" name="letra" value="{{ filtros.letra }}">
  {% endif %}

  <div class="bg-white rounded-xl border p-4">
    <div class="flex items-center gap-2 mb-3">
      <span class="text-lg">🔍</span>
      <h3 class="font-medium text-gray-800">Filtros Avançados</h3>
    </div>

    <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
      <!-- Filtro por Urgência -->
      <div>
        <label class="block text-xs text-gray-600 mb-1">Nível de Urgência</label>
        <select name="urgencia" class="w-full border rounded px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-orange-400">
          <option value="">Todos os níveis</option>
          <option value="critica" {{ 'selected' if filtros.urgencia == 'critica' else '' }}>🚨 Crítica (+3 meses)</option>
          <option value="alta" {{ 'selected' if filtros.urgencia == 'alta' else '' }}>⚠️ Alta (2-3 meses)</option>
          <option value="media" {{ 'selected' if filtros.urgencia == 'media' else '' }}>📋 Média (1-2 meses)</option>
          <option value="baixa" {{ 'selected' if filtros.urgencia == 'baixa' else '' }}>✅ Baixa (< 1 mês)</option>
        </select>
      </div>

      <!-- Filtro por Mês -->
      <div>
        <label class="block text-xs text-gray-600 mb-1">Mês da Última Supernova</label>
        <input type="month" name="mes" value="{{ filtros.mes }}"
               class="w-full border rounded px-3 py-2 text-sm focus:outline-none focus:ring-2 focus:ring-orange-400">
      </div>

      <!-- Botões -->
      <div class="flex items-end gap-2">
        <button type="submit" class="px-4 py-2 rounded bg-orange-600 text-white text-sm hover:bg-orange-700 focus:outline-none focus:ring-2 focus:ring-orange-400">
          Filtrar
        </button>
        {% if filtros.urgencia or filtros.mes %}
          <a href="{{ url_for('clientes.supernova', letra=filtros.letra) }}"
             class="px-4 py-2 rounded border text-sm text-gray-700 hover:bg-gray-50">
            Limpar
          </a>
        {% endif %}
      </div>
    </div>

    <!-- Status dos filtros ativos -->
    {% if filtros.urgencia or filtros.mes %}
    <div class="mt-3 flex flex-wrap gap-2">
      <span class="text-xs text-gray-600">Filtros ativos:</span>
      {% if filtros.urgencia %}
        <span class="px-2 py-1 bg-orange-100 text-orange-800 rounded text-xs">
          Urgência: {{ filtros.urgencia.title() }}
        </span>
      {% endif %}
      {% if filtros.mes %}
        {% set mes_formatado = filtros.mes|replace('-', '/') %}
        <span class="px-2 py-1 bg-blue-100 text-blue-800 rounded text-xs">
          Mês: {{ mes_formatado }}
        </span>
      {% endif %}
    </div>
    {% endif %}
  </div>
</form>

<!-- Estatísticas Rápidas -->
{% if clientes_supernova %}
{% set total_clientes = clientes_supernova|length %}
{% set clientes_critica = clientes_supernova|selectattr('urgencia_flag', 'equalto', 'critica')|list|length %}
{% set clientes_alta = clientes_supernova|selectattr('urgencia_flag', 'equalto', 'alta')|list|length %}
{% set clientes_media = clientes_supernova|selectattr('urgencia_flag', 'equalto', 'media')|list|length %}
{% set clientes_baixa = clientes_supernova|selectattr('urgencia_flag', 'equalto', 'baixa')|list|length %}

<div class="mb-6 bg-white rounded-xl border p-4">
  <div class="flex items-center gap-2 mb-3">
    <span class="text-lg">📊</span>
    <h3 class="font-medium text-gray-800">Resumo por Urgência</h3>
  </div>

  <div class="grid grid-cols-2 md:grid-cols-5 gap-3">
    <div class="text-center p-3 bg-gray-50 rounded-lg">
      <div class="text-xl font-bold text-gray-800">{{ total_clientes }}</div>
      <div class="text-xs text-gray-600 font-medium">Total</div>
    </div>

    <div class="text-center p-3 bg-red-50 rounded-lg border border-red-200">
      <div class="text-xl font-bold text-red-800">{{ clientes_critica }}</div>
      <div class="text-xs text-red-600 font-medium">🚨 Crítica</div>
      {% if clientes_critica > 0 %}
      <div class="text-xs text-red-500 mt-1">+3 meses ou sem registro</div>
      {% endif %}
    </div>

    <div class="text-center p-3 bg-orange-50 rounded-lg border border-orange-200">
      <div class="text-xl font-bold text-orange-800">{{ clientes_alta }}</div>
      <div class="text-xs text-orange-600 font-medium">⚠️ Alta</div>
      {% if clientes_alta > 0 %}
      <div class="text-xs text-orange-500 mt-1">2-3 meses</div>
      {% endif %}
    </div>

    <div class="text-center p-3 bg-yellow-50 rounded-lg border border-yellow-200">
      <div class="text-xl font-bold text-yellow-800">{{ clientes_media }}</div>
      <div class="text-xs text-yellow-600 font-medium">📋 Média</div>
      {% if clientes_media > 0 %}
      <div class="text-xs text-yellow-500 mt-1">1-2 meses</div>
      {% endif %}
    </div>

    <div class="text-center p-3 bg-green-50 rounded-lg border border-green-200">
      <div class="text-xl font-bold text-green-800">{{ clientes_baixa }}</div>
      <div class="text-xs text-green-600 font-medium">✅ Baixa</div>
      {% if clientes_baixa > 0 %}
      <div class="text-xs text-green-500 mt-1">< 1 mês</div>
      {% endif %}
    </div>
  </div>
</div>
{% endif %}

<!-- Tabela de Clientes Supernova -->
<div class="border rounded-xl overflow-hidden bg-white">
  <div class="p-4 border-b bg-gray-50">
    <div class="flex items-center justify-between">
      <div class="flex items-center gap-2">
        <span class="text-xl">⭐</span>
        <h2 class="text-lg font-medium text-gray-800">Clientes e Datas de Supernova</h2>
      </div>

      {% if clientes_supernova %}
        <div class="text-sm text-gray-600">
          <span class="font-medium">{{ clientes_supernova|length }}</span>
          {% if filtros.urgencia or filtros.mes or filtros.letra %}
            resultado(s) encontrado(s)
          {% else %}
            cliente(s) total
          {% endif %}
        </div>
      {% endif %}
    </div>
  </div>

  <div class="overflow-x-auto">
    <table class="min-w-full text-sm">
      <thead class="bg-gray-100">
        <tr>
          <th class="text-left px-4 py-3 font-medium text-gray-700">Nome do Cliente</th>
          <th class="text-left px-4 py-3 font-medium text-gray-700">Data da Última Supernova</th>
          <th class="text-center px-4 py-3 font-medium text-gray-700">Urgência</th>
          <th class="text-center px-4 py-3 font-medium text-gray-700">Ações</th>
        </tr>
      </thead>
      <tbody>
        {% if clientes_supernova %}
          {% for cliente in clientes_supernova %}
          <tr class="border-b hover:bg-gray-50 transition-colors">
            <td class="px-4 py-3 font-medium text-gray-900">
              {{ cliente.nome or '—' }}
            </td>
            <td class="px-4 py-3">
              {% if cliente.data_ultima_supernova %}
                <span class="text-gray-700">
                  {{ cliente.data_ultima_supernova.strftime('%d/%m/%Y') if cliente.data_ultima_supernova.strftime else cliente.data_ultima_supernova }}
                </span>
              {% else %}
                <span class="text-gray-400 italic">Sem registro</span>
              {% endif %}
            </td>
            <td class="px-4 py-3 text-center">
              {% if cliente.urgencia_flag == 'critica' %}
                <div class="flex flex-col items-center">
                  <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-bold bg-red-100 text-red-800 border border-red-300">
                    🚨 CRÍTICA
                  </span>
                  {% if cliente.dias_desde_supernova %}
                    <span class="text-xs text-red-600 mt-1">{{ cliente.dias_desde_supernova }} dias</span>
                  {% else %}
                    <span class="text-xs text-red-600 mt-1">Sem registro</span>
                  {% endif %}
                </div>
              {% elif cliente.urgencia_flag == 'alta' %}
                <div class="flex flex-col items-center">
                  <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-orange-100 text-orange-800 border border-orange-300">
                    ⚠️ ALTA
                  </span>
                  <span class="text-xs text-orange-600 mt-1">{{ cliente.dias_desde_supernova }} dias</span>
                </div>
              {% elif cliente.urgencia_flag == 'media' %}
                <div class="flex flex-col items-center">
                  <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800 border border-yellow-300">
                    📋 MÉDIA
                  </span>
                  <span class="text-xs text-yellow-600 mt-1">{{ cliente.dias_desde_supernova }} dias</span>
                </div>
              {% else %}
                <div class="flex flex-col items-center">
                  <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800 border border-green-300">
                    ✅ BAIXA
                  </span>
                  <span class="text-xs text-green-600 mt-1">{{ cliente.dias_desde_supernova }} dias</span>
                </div>
              {% endif %}
            </td>
            <td class="px-4 py-3 text-center">
              <button
                onclick="abrirModalSupernova('{{ cliente.id }}', '{{ cliente.nome }}', '{{ cliente.data_ultima_supernova.strftime('%Y-%m-%d') if cliente.data_ultima_supernova else '' }}', '{{ cliente.observacoes_supernova or '' }}')"
                class="px-3 py-1.5 rounded {% if cliente.urgencia_flag == 'critica' %}bg-red-600 hover:bg-red-700{% else %}bg-blue-600 hover:bg-blue-700{% endif %} text-white text-xs focus:outline-none focus:ring-2 focus:ring-blue-400"
                title="{% if cliente.data_ultima_supernova %}Editar data{% else %}Adicionar data{% endif %}">
                {% if cliente.data_ultima_supernova %}✏️{% else %}+{% endif %}
              </button>
            </td>
          </tr>
          {% endfor %}
        {% else %}
          <tr>
            <td colspan="4" class="px-4 py-8 text-center text-gray-500">
              <div class="flex flex-col items-center gap-2">
                <span class="text-3xl">⭐</span>
                <span class="font-medium">Nenhum cliente encontrado</span>
                <span class="text-sm">Cadastre clientes primeiro para visualizar dados de supernova.</span>
                <a href="{{ url_for('clientes.index') }}"
                   class="mt-2 px-4 py-2 bg-blue-600 text-white rounded-lg text-sm hover:bg-blue-700">
                  Ver Clientes
                </a>
              </div>
            </td>
          </tr>
        {% endif %}
      </tbody>
    </table>
  </div>
</div>

<!-- Informações sobre Supernova -->
<div class="mt-6 p-4 bg-blue-50 border border-blue-200 rounded-lg">
  <div class="flex items-start gap-3">
    <span class="text-blue-500 text-lg">ℹ️</span>
    <div>
      <h3 class="font-medium text-blue-800 mb-1">Sobre os Dados de Supernova</h3>
      <p class="text-sm text-blue-700">
        As datas de supernova são obtidas da tabela de registros do sistema. Se um cliente não possui data registrada, significa que ainda não houve uma supernova para esse cliente ou os dados não foram sincronizados.
      </p>
    </div>
  </div>
</div>

<!-- Modal para inserir/editar data da supernova -->
<div id="modalSupernova" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50 flex items-center justify-center p-4">
  <div class="bg-white rounded-lg p-6 w-full max-w-md">
    <h3 class="text-lg font-medium mb-4">
      <span id="modalTitulo">Definir Data da Supernova</span>
    </h3>

    <form method="post" action="{{ url_for('clientes.salvar_supernova') }}" id="formSupernova">
      <input type="hidden" name="cliente_id" id="clienteIdInput">

      <div class="space-y-4">
        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Cliente</label>
          <input type="text" id="clienteNomeDisplay" class="w-full px-3 py-2 border rounded-lg bg-gray-100" readonly>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Data da Supernova *</label>
          <input type="date" name="data_supernova" id="dataSupernovaInput"
                 class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400"
                 required>
          <p class="text-xs text-gray-500 mt-1">Formato: DD/MM/AAAA</p>
        </div>

        <div>
          <label class="block text-sm font-medium text-gray-700 mb-1">Observações (opcional)</label>
          <textarea name="observacoes" id="observacoesInput"
                    class="w-full px-3 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400"
                    rows="3"
                    placeholder="Detalhes sobre a supernova..."></textarea>
        </div>
      </div>

      <div class="flex gap-3 mt-6">
        <button type="button" onclick="fecharModalSupernova()"
                class="flex-1 px-4 py-2 border rounded-lg text-gray-700 hover:bg-gray-50">
          Cancelar
        </button>
        <button type="submit"
                class="flex-1 px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 focus:outline-none focus:ring-2 focus:ring-blue-400">
          Salvar
        </button>
      </div>
    </form>
  </div>
</div>

<script>
function abrirModalSupernova(clienteId, nomeCliente, dataExistente, observacoesExistentes) {
  const modal = document.getElementById('modalSupernova');
  const titulo = document.getElementById('modalTitulo');

  // Configurar campos
  document.getElementById('clienteIdInput').value = clienteId;
  document.getElementById('clienteNomeDisplay').value = nomeCliente;
  document.getElementById('observacoesInput').value = observacoesExistentes || '';

  // Configurar data
  if (dataExistente) {
    document.getElementById('dataSupernovaInput').value = dataExistente;
    titulo.textContent = 'Editar Data da Supernova';
  } else {
    titulo.textContent = 'Definir Data da Supernova';
    // Definir data atual como padrão (sem hora)
    const agora = new Date();
    const ano = agora.getFullYear();
    const mes = String(agora.getMonth() + 1).padStart(2, '0');
    const dia = String(agora.getDate()).padStart(2, '0');

    document.getElementById('dataSupernovaInput').value = `${ano}-${mes}-${dia}`;
  }

  // Mostrar modal
  modal.classList.remove('hidden');

  // Focar no campo de data
  setTimeout(() => {
    document.getElementById('dataSupernovaInput').focus();
  }, 100);
}

function fecharModalSupernova() {
  document.getElementById('modalSupernova').classList.add('hidden');
}

// Fechar modal ao clicar fora
document.getElementById('modalSupernova').addEventListener('click', function(e) {
  if (e.target === this) {
    fecharModalSupernova();
  }
});

// Fechar modal com ESC
document.addEventListener('keydown', function(e) {
  if (e.key === 'Escape') {
    fecharModalSupernova();
  }
});
</script>

{% endblock %}