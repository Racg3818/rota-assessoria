{% extends "base.html" %}
{% block title %}Asset Allocation ‚Äî Rota Assessoria{% endblock %}
{% block subtitle %}An√°lise de Distribui√ß√£o de Ativos{% endblock %}
{% block content %}

<!-- Header Moderno -->
<div class="relative mb-8 bg-gradient-to-br from-indigo-600 via-purple-600 to-pink-700 rounded-3xl p-6 text-white overflow-hidden">
  <div class="absolute inset-0 opacity-10">
    <div class="absolute top-0 -left-4 w-64 h-64 bg-white rounded-full mix-blend-multiply filter blur-xl animate-pulse"></div>
    <div class="absolute top-0 -right-4 w-64 h-64 bg-purple-300 rounded-full mix-blend-multiply filter blur-xl animate-pulse animation-delay-2000"></div>
  </div>

  <div class="relative z-10">
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
      <div>
        <div class="flex items-center gap-3 mb-2">
          <div class="w-10 h-10 bg-white/20 rounded-xl flex items-center justify-center">
            <span class="text-xl">üìä</span>
          </div>
          <h1 class="text-2xl md:text-3xl font-bold text-white">Asset Allocation</h1>
        </div>
        <p class="text-purple-100 text-sm md:text-base">Visualize a distribui√ß√£o de ativos por categoria</p>
      </div>

      <div class="flex flex-wrap gap-2">
        <a href="{{ url_for('clientes.insights') }}"
           class="px-4 py-2 bg-white/10 hover:bg-white/20 text-white rounded-xl text-sm font-medium transition-colors border border-white/20 backdrop-blur-sm">
          üí° Insights
        </a>
        <a href="{{ url_for('clientes.index') }}"
           class="px-4 py-2 bg-white text-purple-700 rounded-xl text-sm font-bold hover:bg-gray-50 transition-colors shadow-lg">
          ‚Üê Voltar para Clientes
        </a>
      </div>
    </div>
  </div>
</div>

<!-- Sele√ß√£o de Cliente -->
<div class="mb-6 bg-white rounded-xl border p-6">
  <h2 class="text-lg font-bold text-gray-800 mb-4">üîç Selecione um Cliente</h2>

  {% if not clientes %}
  <div class="bg-amber-50 border border-amber-200 rounded-lg p-4 text-amber-800">
    <p class="font-medium">‚ö†Ô∏è Nenhum dado dispon√≠vel</p>
    <p class="text-sm mt-1">
      Fa√ßa o upload do arquivo <strong>Diversificador.xlsx</strong> na tela de
      <a href="{{ url_for('diversificador.index') }}" class="underline font-bold">Diversificador</a>
      para visualizar a distribui√ß√£o de ativos.
    </p>
  </div>
  {% else %}
  <!-- Filtros Alfab√©ticos -->
  {% if letras_disponiveis %}
  <div class="mb-4">
    <p class="text-sm text-gray-600 mb-2 font-medium">Filtrar por inicial:</p>
    <div class="flex flex-wrap gap-2">
      <button type="button" onclick="filtrarPorLetra('')"
              class="filtro-letra px-3 py-1.5 text-sm font-medium rounded-lg border-2 transition-all duration-200 border-purple-600 bg-purple-600 text-white hover:bg-purple-700"
              data-letra="">
        Todos
      </button>
      {% for letra in letras_disponiveis %}
      <button type="button" onclick="filtrarPorLetra('{{ letra }}')"
              class="filtro-letra px-3 py-1.5 text-sm font-medium rounded-lg border-2 transition-all duration-200 border-gray-300 bg-white text-gray-700 hover:border-purple-400 hover:bg-purple-50"
              data-letra="{{ letra }}">
        {{ letra }}
      </button>
      {% endfor %}
    </div>
  </div>
  {% endif %}

  <form method="get" action="{{ url_for('clientes.asset_allocation') }}" class="flex gap-3">
    <select name="cliente" id="selectCliente" required
            class="flex-1 px-3 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
      <option value="">-- Selecione um cliente --</option>
      {% for cliente in clientes %}
      <option value="{{ cliente.codigo }}" data-nome="{{ cliente.nome }}" {% if cliente.codigo == cliente_selecionado %}selected{% endif %}>
        {{ cliente.nome }}
      </option>
      {% endfor %}
    </select>
    <button type="submit"
            class="px-6 py-2 bg-purple-600 text-white rounded-lg hover:bg-purple-700 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-purple-500 font-medium">
      Visualizar
    </button>
  </form>
  {% endif %}
</div>

<!-- Visualiza√ß√£o de Dados -->
{% if cliente_selecionado %}
<div class="space-y-6">

  <!-- üí∞ EXPOSI√á√ÉO RENDA FIXA (NOVO) -->
  {% if exposicao_rf and exposicao_rf.total_rf and exposicao_rf.total_rf > 0 %}
  <div class="bg-gradient-to-br from-green-50 to-emerald-50 rounded-xl border-2 border-green-200 p-6">
    <div class="flex items-center gap-3 mb-6">
      <span class="text-3xl">üí∞</span>
      <div>
        <h2 class="text-2xl font-bold text-gray-800">Exposi√ß√£o Renda Fixa</h2>
        <p class="text-sm text-gray-600">Distribui√ß√£o por tipo de indexador</p>
      </div>
    </div>

    <!-- Grid de Cards RF -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">

      <!-- Card P√≥s-fixado -->
      <div class="bg-white rounded-xl shadow-lg p-5 border border-blue-200 hover:shadow-xl transition-shadow">
        <div class="flex items-center gap-2 mb-3">
          <div class="w-10 h-10 bg-blue-100 rounded-xl flex items-center justify-center">
            <span class="text-xl">üìà</span>
          </div>
          <div class="flex-1">
            <h3 class="text-xs font-medium text-gray-600">P√≥s-fixado</h3>
            <p class="text-xs text-gray-500">CDI, Selic, LFT</p>
          </div>
        </div>
        <div class="mb-3">
          <div class="text-2xl font-bold text-blue-600">{{ "%.1f"|format(exposicao_rf.pos_fixado.percentual) }}%</div>
          <div class="text-xs text-gray-600 font-mono">{{ exposicao_rf.pos_fixado.total|brl }}</div>
          {% if exposicao_rf.pos_fixado.taxa_ponderada and exposicao_rf.pos_fixado.taxa_ponderada > 0 %}
          <div class="text-xs text-blue-600 font-bold mt-1">Taxa: {{ "%.2f"|format(exposicao_rf.pos_fixado.taxa_ponderada) }}% CDI</div>
          {% endif %}
        </div>
        <div class="w-full bg-gray-200 rounded-full h-2">
          <div class="bg-gradient-to-r from-blue-400 to-blue-600 h-2 rounded-full transition-all duration-500"
               style="width: {{ exposicao_rf.pos_fixado.percentual }}%"></div>
        </div>
      </div>

      <!-- Card Prefixado -->
      <div class="bg-white rounded-xl shadow-lg p-5 border border-purple-200 hover:shadow-xl transition-shadow">
        <div class="flex items-center gap-2 mb-3">
          <div class="w-10 h-10 bg-purple-100 rounded-xl flex items-center justify-center">
            <span class="text-xl">üìä</span>
          </div>
          <div class="flex-1">
            <h3 class="text-xs font-medium text-gray-600">Prefixado</h3>
            <p class="text-xs text-gray-500">Taxa fixa</p>
          </div>
        </div>
        <div class="mb-3">
          <div class="text-2xl font-bold text-purple-600">{{ "%.1f"|format(exposicao_rf.pre_fixado.percentual) }}%</div>
          <div class="text-xs text-gray-600 font-mono">{{ exposicao_rf.pre_fixado.total|brl }}</div>
          {% if exposicao_rf.pre_fixado.taxa_ponderada and exposicao_rf.pre_fixado.taxa_ponderada > 0 %}
          <div class="text-xs text-purple-600 font-bold mt-1">Taxa: {{ "%.2f"|format(exposicao_rf.pre_fixado.taxa_ponderada) }}% a.a.</div>
          {% endif %}
        </div>
        <div class="w-full bg-gray-200 rounded-full h-2">
          <div class="bg-gradient-to-r from-purple-400 to-purple-600 h-2 rounded-full transition-all duration-500"
               style="width: {{ exposicao_rf.pre_fixado.percentual }}%"></div>
        </div>
      </div>

      <!-- Card Infla√ß√£o -->
      <div class="bg-white rounded-xl shadow-lg p-5 border border-orange-200 hover:shadow-xl transition-shadow">
        <div class="flex items-center gap-2 mb-3">
          <div class="w-10 h-10 bg-orange-100 rounded-xl flex items-center justify-center">
            <span class="text-xl">üìâ</span>
          </div>
          <div class="flex-1">
            <h3 class="text-xs font-medium text-gray-600">Infla√ß√£o</h3>
            <p class="text-xs text-gray-500">IPCA</p>
          </div>
        </div>
        <div class="mb-3">
          <div class="text-2xl font-bold text-orange-600">{{ "%.1f"|format(exposicao_rf.inflacao.percentual) }}%</div>
          <div class="text-xs text-gray-600 font-mono">{{ exposicao_rf.inflacao.total|brl }}</div>
          {% if exposicao_rf.inflacao.taxa_ponderada and exposicao_rf.inflacao.taxa_ponderada > 0 %}
          <div class="text-xs text-orange-600 font-bold mt-1">Taxa: IPCA + {{ "%.2f"|format(exposicao_rf.inflacao.taxa_ponderada) }}%</div>
          {% endif %}
        </div>
        <div class="w-full bg-gray-200 rounded-full h-2">
          <div class="bg-gradient-to-r from-orange-400 to-orange-600 h-2 rounded-full transition-all duration-500"
               style="width: {{ exposicao_rf.inflacao.percentual }}%"></div>
        </div>
      </div>

      <!-- Card Internacional -->
      <div class="bg-white rounded-xl shadow-lg p-5 border border-teal-200 hover:shadow-xl transition-shadow">
        <div class="flex items-center gap-2 mb-3">
          <div class="w-10 h-10 bg-teal-100 rounded-xl flex items-center justify-center">
            <span class="text-xl">üåé</span>
          </div>
          <div class="flex-1">
            <h3 class="text-xs font-medium text-gray-600">Internacional</h3>
            <p class="text-xs text-gray-500">D√≥lar</p>
          </div>
        </div>
        <div class="mb-3">
          <div class="text-2xl font-bold text-teal-600">{{ "%.1f"|format(exposicao_rf.internacional.percentual) }}%</div>
          <div class="text-xs text-gray-600 font-mono">{{ exposicao_rf.internacional.total|brl }}</div>
          {% if exposicao_rf.internacional.taxa_ponderada and exposicao_rf.internacional.taxa_ponderada > 0 %}
          <div class="text-xs text-teal-600 font-bold mt-1">Taxa: {{ "%.2f"|format(exposicao_rf.internacional.taxa_ponderada) }}% a.a.</div>
          {% endif %}
        </div>
        <div class="w-full bg-gray-200 rounded-full h-2">
          <div class="bg-gradient-to-r from-teal-400 to-teal-600 h-2 rounded-full transition-all duration-500"
               style="width: {{ exposicao_rf.internacional.percentual }}%"></div>
        </div>
      </div>

    </div>

    <!-- Total RF -->
    <div class="bg-white rounded-xl shadow-lg p-4 border border-green-200">
      <div class="flex items-center justify-between">
        <div>
          <h3 class="text-sm font-medium text-gray-600">Total Renda Fixa</h3>
          <p class="text-xs text-gray-500">Valor total da cust√≥dia</p>
        </div>
        <div class="text-right">
          <div class="text-2xl font-bold text-green-600">{{ exposicao_rf.total_rf|brl }}</div>
        </div>
      </div>
    </div>

    <!-- Gr√°fico de Exposi√ß√£o RF por Indexador -->
    <div class="bg-white rounded-xl shadow-lg p-6 border border-green-200 mt-6">
      <div class="flex items-center gap-3 mb-6">
        <div class="w-10 h-10 bg-green-100 rounded-xl flex items-center justify-center">
          <span class="text-xl">üìä</span>
        </div>
        <div class="flex-1">
          <h3 class="text-xl font-bold text-gray-800">Gr√°fico de Exposi√ß√£o por Indexador</h3>
          <p class="text-sm text-gray-600">Distribui√ß√£o percentual dos tipos de indexadores</p>
        </div>
      </div>

      <div class="flex flex-col md:flex-row items-center gap-8">
        <!-- Gr√°fico de Pizza -->
        <div class="w-full md:w-1/2 flex justify-center">
          <div class="relative" style="max-width: 320px;">
            <canvas id="chartExposicaoIndexadores"></canvas>
          </div>
        </div>

        <!-- Legenda -->
        <div class="w-full md:w-1/2 space-y-4">
          <div class="flex items-center gap-3 p-3 bg-blue-50 rounded-lg">
            <div class="w-6 h-6 rounded-lg bg-gradient-to-br from-blue-400 to-blue-600"></div>
            <div class="flex-1">
              <div class="text-sm font-semibold text-gray-800">P√≥s-fixado</div>
              <div class="text-xs text-gray-600">CDI, Selic, LFT, Renda+</div>
            </div>
            <div class="text-right">
              <div class="text-lg font-bold text-blue-600">{{ "%.1f"|format(exposicao_rf.pos_fixado.percentual) }}%</div>
              <div class="text-xs text-gray-600">{{ exposicao_rf.pos_fixado.total|brl }}</div>
            </div>
          </div>

          <div class="flex items-center gap-3 p-3 bg-purple-50 rounded-lg">
            <div class="w-6 h-6 rounded-lg bg-gradient-to-br from-purple-400 to-purple-600"></div>
            <div class="flex-1">
              <div class="text-sm font-semibold text-gray-800">Prefixado</div>
              <div class="text-xs text-gray-600">Taxa fixa</div>
            </div>
            <div class="text-right">
              <div class="text-lg font-bold text-purple-600">{{ "%.1f"|format(exposicao_rf.pre_fixado.percentual) }}%</div>
              <div class="text-xs text-gray-600">{{ exposicao_rf.pre_fixado.total|brl }}</div>
            </div>
          </div>

          <div class="flex items-center gap-3 p-3 bg-orange-50 rounded-lg">
            <div class="w-6 h-6 rounded-lg bg-gradient-to-br from-orange-400 to-orange-600"></div>
            <div class="flex-1">
              <div class="text-sm font-semibold text-gray-800">Infla√ß√£o</div>
              <div class="text-xs text-gray-600">IPCA</div>
            </div>
            <div class="text-right">
              <div class="text-lg font-bold text-orange-600">{{ "%.1f"|format(exposicao_rf.inflacao.percentual) }}%</div>
              <div class="text-xs text-gray-600">{{ exposicao_rf.inflacao.total|brl }}</div>
            </div>
          </div>

          <div class="flex items-center gap-3 p-3 bg-teal-50 rounded-lg">
            <div class="w-6 h-6 rounded-lg bg-gradient-to-br from-teal-400 to-teal-600"></div>
            <div class="flex-1">
              <div class="text-sm font-semibold text-gray-800">Internacional</div>
              <div class="text-xs text-gray-600">D√≥lar PTAX</div>
            </div>
            <div class="text-right">
              <div class="text-lg font-bold text-teal-600">{{ "%.1f"|format(exposicao_rf.internacional.percentual) }}%</div>
              <div class="text-xs text-gray-600">{{ exposicao_rf.internacional.total|brl }}</div>
            </div>
          </div>
        </div>
      </div>
    </div>

  </div>
  {% endif %}

  <!-- üé® EXPOSI√á√ÉO POR TIPO DE ATIVO (NOVO) -->
  {% if exposicao_por_tipo and exposicao_por_tipo.total_geral > 0 %}
  <div class="bg-gradient-to-br from-purple-50 to-pink-50 rounded-xl border-2 border-purple-200 p-6">
    <div class="flex items-center gap-3 mb-6">
      <span class="text-3xl">üéØ</span>
      <div>
        <h2 class="text-2xl font-bold text-gray-800">Exposi√ß√£o por Tipo de Ativo</h2>
        <p class="text-sm text-gray-600">Classifica√ß√£o detalhada dos investimentos</p>
      </div>
    </div>

    <!-- Grid de Cards -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">

      <!-- Card Emiss√£o Banc√°ria -->
      <div class="bg-white rounded-xl shadow-lg p-6 border border-blue-200 hover:shadow-xl transition-shadow">
        <div class="flex items-center gap-3 mb-4">
          <div class="w-12 h-12 bg-blue-100 rounded-xl flex items-center justify-center">
            <span class="text-2xl">üè¶</span>
          </div>
          <div class="flex-1">
            <h3 class="text-sm font-medium text-gray-600">Emiss√£o Banc√°ria</h3>
            <p class="text-xs text-gray-500">CDB, LCI, LCA, LCD, LF</p>
          </div>
        </div>
        <div class="mb-4">
          <div class="text-3xl font-bold text-blue-600">{{ "%.1f"|format(exposicao_por_tipo.emissao_bancaria.percentual) }}%</div>
          <div class="text-sm text-gray-600 font-mono">{{ exposicao_por_tipo.emissao_bancaria.total|brl }}</div>          
        </div>
        <!-- Barra de Progresso -->
        <div class="w-full bg-gray-200 rounded-full h-3 mb-4">
          <div class="bg-gradient-to-r from-blue-400 to-blue-600 h-3 rounded-full transition-all duration-500"
               style="width: {{ exposicao_por_tipo.emissao_bancaria.percentual }}%"></div>
        </div>        
      </div>

      <!-- Card Cr√©dito Privado -->
      <div class="bg-white rounded-xl shadow-lg p-6 border border-purple-200 hover:shadow-xl transition-shadow">
        <div class="flex items-center gap-3 mb-4">
          <div class="w-12 h-12 bg-purple-100 rounded-xl flex items-center justify-center">
            <span class="text-2xl">üìú</span>
          </div>
          <div class="flex-1">
            <h3 class="text-sm font-medium text-gray-600">Cr√©dito Privado</h3>
            <p class="text-xs text-gray-500">DEB, CDCA, CRA, CRI, FIDC</p>
          </div>
        </div>
        <div class="mb-4">
          <div class="text-3xl font-bold text-purple-600">{{ "%.1f"|format(exposicao_por_tipo.credito_privado.percentual) }}%</div>
          <div class="text-sm text-gray-600 font-mono">{{ exposicao_por_tipo.credito_privado.total|brl }}</div>          
        </div>
        <!-- Barra de Progresso -->
        <div class="w-full bg-gray-200 rounded-full h-3 mb-4">
          <div class="bg-gradient-to-r from-purple-400 to-purple-600 h-3 rounded-full transition-all duration-500"
               style="width: {{ exposicao_por_tipo.credito_privado.percentual }}%"></div>
        </div>        
      </div>

      <!-- Card T√≠tulo P√∫blico -->
      <div class="bg-white rounded-xl shadow-lg p-6 border border-green-200 hover:shadow-xl transition-shadow">
        <div class="flex items-center gap-3 mb-4">
          <div class="w-12 h-12 bg-green-100 rounded-xl flex items-center justify-center">
            <span class="text-2xl">üèõÔ∏è</span>
          </div>
          <div class="flex-1">
            <h3 class="text-sm font-medium text-gray-600">T√≠tulo P√∫blico</h3>
            <p class="text-xs text-gray-500">NTN-B, LFT, LTN, NTN-F, NTN-C</p>
          </div>
        </div>
        <div class="mb-4">
          <div class="text-3xl font-bold text-green-600">{{ "%.1f"|format(exposicao_por_tipo.titulo_publico.percentual) }}%</div>
          <div class="text-sm text-gray-600 font-mono">{{ exposicao_por_tipo.titulo_publico.total|brl }}</div>          
        </div>
        <!-- Barra de Progresso -->
        <div class="w-full bg-gray-200 rounded-full h-3 mb-4">
          <div class="bg-gradient-to-r from-green-400 to-green-600 h-3 rounded-full transition-all duration-500"
               style="width: {{ exposicao_por_tipo.titulo_publico.percentual }}%"></div>
        </div>        
      </div>
    </div>

    <!-- üîç AN√ÅLISE DETALHADA: VENCIMENTOS E EMISSORES -->
    {% if credito_privado_vencimentos or credito_privado_emissores %}
    <div class="bg-purple-50 rounded-xl border-2 border-purple-200 p-6 mt-6">
      <div class="flex items-center gap-3 mb-6">
        <span class="text-3xl">üîç</span>
        <div>
          <h3 class="text-xl font-bold text-gray-800">An√°lise Detalhada</h3>
          <p class="text-sm text-gray-600">Vencimentos da Carteira e Exposi√ß√£o por Emissor (Cr√©dito Privado)</p>
        </div>
      </div>

      <div class="grid grid-cols-1 md:grid-cols-2 gap-6">

        <!-- Card de Vencimentos -->
        <div class="bg-white rounded-xl shadow-lg p-6 border border-purple-200">
          <div class="flex items-center gap-3 mb-4">
            <div class="w-10 h-10 bg-purple-100 rounded-xl flex items-center justify-center">
              <span class="text-xl">üìÖ</span>
            </div>
            <div class="flex-1">
              <h4 class="text-base font-bold text-gray-800">Distribui√ß√£o por Vencimento</h4>
              <p class="text-xs text-gray-500">Valores somados por ano de vencimento</p>
            </div>
          </div>

          {% if credito_privado_vencimentos %}
          <!-- Gr√°fico de Barras -->
          <div>
            <canvas id="chartVencimentos" style="max-height: 300px;"></canvas>
          </div>
          {% else %}
          <p class="text-sm text-gray-500">Nenhum dado de vencimento dispon√≠vel.</p>
          {% endif %}
        </div>

        <!-- Card de Exposi√ß√£o por Emissor -->
        <div class="bg-white rounded-xl shadow-lg p-6 border border-purple-200">
          <div class="flex items-center gap-3 mb-4">
            <div class="w-10 h-10 bg-purple-100 rounded-xl flex items-center justify-center">
              <span class="text-xl">üè¢</span>
            </div>
            <div class="flex-1">
              <h4 class="text-base font-bold text-gray-800">Exposi√ß√£o por Emissor</h4>
              <p class="text-xs text-gray-500">Top emissores de Cr√©dito Privado</p>
            </div>
          </div>

          {% if credito_privado_emissores %}
          <div class="space-y-3">
            {% for emissor in credito_privado_emissores %}
            <div class="{% if emissor.acima_fgc %}border-2 border-amber-400 bg-amber-50 rounded-lg p-3{% else %}border-b border-gray-100{% endif %} pb-3 last:border-b-0">
              <div class="flex justify-between items-center mb-2">
                <div class="flex items-center gap-2 flex-1">
                  {% if emissor.acima_fgc %}
                  <span class="text-amber-600 text-base" title="Acima da cobertura do FGC (R$ 250.000)">‚ö†Ô∏è</span>
                  {% endif %}
                  <span class="text-sm font-medium {% if emissor.acima_fgc %}text-amber-900{% else %}text-gray-700{% endif %} truncate">{{ emissor.nome }}</span>
                </div>
                <span class="text-sm font-bold {% if emissor.acima_fgc %}text-amber-700{% else %}text-purple-600{% endif %} ml-2">{{ "%.1f"|format(emissor.percentual_carteira) }}%</span>
              </div>
              <div class="flex justify-between items-center mb-1">
                <span class="text-xs {% if emissor.acima_fgc %}text-amber-700 font-semibold{% else %}text-gray-500{% endif %}">{{ emissor.total|brl }}</span>
                <span class="text-xs {% if emissor.acima_fgc %}text-amber-600{% else %}text-gray-500{% endif %}">{{ emissor.count }} ativo(s)</span>
              </div>
              <div class="w-full bg-gray-200 rounded-full h-2">
                <div class="{% if emissor.acima_fgc %}bg-gradient-to-r from-amber-400 to-amber-600{% else %}bg-gradient-to-r from-purple-400 to-purple-600{% endif %} h-2 rounded-full transition-all duration-500"
                     style="width: {{ emissor.percentual_carteira }}%"></div>
              </div>
              {% if emissor.acima_fgc %}
              <div class="mt-2 text-xs text-amber-700 font-medium">
                ‚ö†Ô∏è Exposi√ß√£o acima da cobertura do FGC (R$ 250.000)
              </div>
              {% endif %}
            </div>
            {% endfor %}
          </div>
          {% else %}
          <p class="text-sm text-gray-500">Nenhum dado de emissor dispon√≠vel.</p>
          {% endif %}
        </div>

      </div>
    </div>
    {% endif %}
    
  </div>
  {% endif %}

  <!-- üíß MAPA DE LIQUIDEZ (NOVO) -->
  {% if mapa_liquidez %}
  <div class="bg-gradient-to-br from-cyan-50 to-blue-50 rounded-xl border-2 border-cyan-200 p-6">
    <div class="flex items-center gap-3 mb-6">
      <span class="text-3xl">üíß</span>
      <div>
        <h2 class="text-2xl font-bold text-gray-800">Mapa de Liquidez</h2>
        <p class="text-sm text-gray-600">Fundos de investimento e prazos de resgate</p>
      </div>
    </div>

    <!-- Total de Fundos -->
    <div class="bg-white rounded-xl shadow-lg p-4 border border-cyan-200 mb-6">
      <div class="flex items-center justify-between">
        <div>
          <h3 class="text-sm font-medium text-gray-600">Total em Fundos</h3>
          <p class="text-xs text-gray-500">{{ mapa_liquidez|length }} fundo(s) mapeado(s)</p>
        </div>
        <div class="text-right">
          {% set total_fundos = mapa_liquidez|sum(attribute='valor') %}
          <div class="text-2xl font-bold text-cyan-600">{{ total_fundos|brl }}</div>
        </div>
      </div>
    </div>

    <!-- Tabela de Fundos -->
    <div class="bg-white rounded-xl shadow-lg border border-cyan-200 overflow-hidden">
      <div class="overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200">
          <thead class="bg-gradient-to-r from-cyan-500 to-blue-500">
            <tr>
              <th scope="col" class="px-4 py-3 text-left text-xs font-bold text-white uppercase tracking-wider">
                Ativo
              </th>
              <th scope="col" class="px-4 py-3 text-left text-xs font-bold text-white uppercase tracking-wider">
                Classifica√ß√£o CVM
              </th>
              <th scope="col" class="px-4 py-3 text-center text-xs font-bold text-white uppercase tracking-wider">
                Liquidez
              </th>
              <th scope="col" class="px-4 py-3 text-right text-xs font-bold text-white uppercase tracking-wider">
                Valor
              </th>
              <th scope="col" class="px-4 py-3 text-center text-xs font-bold text-white uppercase tracking-wider">
                A√ß√£o
              </th>
            </tr>
          </thead>
          <tbody class="bg-white divide-y divide-gray-200">
            {% for fundo in mapa_liquidez %}
            <tr class="hover:bg-cyan-50 transition-colors">
              <td class="px-4 py-3">
                <div>
                  <div class="text-sm font-medium text-gray-900 truncate max-w-md" title="{{ fundo.nome_fundo }}">
                    {{ fundo.nome_fundo }}
                  </div>
                  <div class="text-xs text-gray-500 font-mono">
                    CNPJ: {{ fundo.cnpj_fundo }}
                  </div>
                </div>
              </td>
              <td class="px-4 py-3">
                {% if fundo.classificacao_cvm == 'A√ß√µes' %}
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-purple-100 text-purple-800">
                  üìà A√ß√µes
                </span>
                {% elif fundo.classificacao_cvm == 'Renda Fixa' %}
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-green-100 text-green-800">
                  üí∞ Renda Fixa
                </span>
                {% elif fundo.classificacao_cvm == 'Multimercado' %}
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-blue-100 text-blue-800">
                  üéØ Multimercado
                </span>
                {% elif fundo.classificacao_cvm == 'Cambial' %}
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-yellow-100 text-yellow-800">
                  üí± Cambial
                </span>
                {% else %}
                <span class="inline-flex items-center px-2.5 py-0.5 rounded-full text-xs font-medium bg-gray-100 text-gray-800">
                  {{ fundo.classificacao_cvm }}
                </span>
                {% endif %}
              </td>
              <td class="px-4 py-3 text-center">
                {% if fundo.resgate_total == 0 %}
                <span class="inline-flex items-center px-3 py-1 rounded-lg text-xs font-bold bg-green-100 text-green-800 border border-green-300">
                  ‚ö° D+0
                </span>
                {% elif fundo.resgate_total == 1 %}
                <span class="inline-flex items-center px-3 py-1 rounded-lg text-xs font-bold bg-blue-100 text-blue-800 border border-blue-300">
                  üíß D+1
                </span>
                {% elif fundo.resgate_total == 2 %}
                <span class="inline-flex items-center px-3 py-1 rounded-lg text-xs font-bold bg-yellow-100 text-yellow-800 border border-yellow-300">
                  ‚è±Ô∏è D+2
                </span>
                {% elif fundo.resgate_total == 3 %}
                <span class="inline-flex items-center px-3 py-1 rounded-lg text-xs font-bold bg-orange-100 text-orange-800 border border-orange-300">
                  ‚è≥ D+3+
                </span>
                {% else %}
                <span class="inline-flex items-center px-3 py-1 rounded-lg text-xs font-bold bg-gray-100 text-gray-800 border border-gray-300">
                  ‚ùì N/A
                </span>
                {% endif %}
              </td>
              <td class="px-4 py-3 text-right">
                <span class="text-sm font-bold text-gray-900">{{ fundo.valor|brl }}</span>
              </td>
              <td class="px-4 py-3 text-center">
                <button onclick="abrirModalAlocacao('{{ fundo.nome_fundo }}', {{ fundo.valor }}, '{{ fundo.cnpj_fundo }}')"
                        class="px-3 py-1.5 bg-purple-600 hover:bg-purple-700 text-white text-xs font-bold rounded-lg transition-colors shadow-sm">
                  üí∞ Alocar
                </button>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

    <!-- Legenda de Liquidez -->
    <div class="mt-6 bg-white rounded-xl shadow-lg p-4 border border-cyan-200">
      <h3 class="text-sm font-bold text-gray-700 mb-3">üìñ Legenda de Liquidez</h3>
      <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
        <div class="flex items-center gap-2">
          <span class="inline-flex items-center px-2 py-1 rounded-lg text-xs font-bold bg-green-100 text-green-800 border border-green-300">
            ‚ö° D+0
          </span>
          <span class="text-xs text-gray-600">Mesmo dia</span>
        </div>
        <div class="flex items-center gap-2">
          <span class="inline-flex items-center px-2 py-1 rounded-lg text-xs font-bold bg-blue-100 text-blue-800 border border-blue-300">
            üíß D+1
          </span>
          <span class="text-xs text-gray-600">1 dia √∫til</span>
        </div>
        <div class="flex items-center gap-2">
          <span class="inline-flex items-center px-2 py-1 rounded-lg text-xs font-bold bg-yellow-100 text-yellow-800 border border-yellow-300">
            ‚è±Ô∏è D+2
          </span>
          <span class="text-xs text-gray-600">2 dias √∫teis</span>
        </div>
        <div class="flex items-center gap-2">
          <span class="inline-flex items-center px-2 py-1 rounded-lg text-xs font-bold bg-orange-100 text-orange-800 border border-orange-300">
            ‚è≥ D+3+
          </span>
          <span class="text-xs text-gray-600">3+ dias √∫teis</span>
        </div>
      </div>
    </div>

  </div>
  {% endif %}




  </div>
</div>
{% endif %}

<!-- üî• MODAL DE ALOCA√á√ÉO DO MAPA DE LIQUIDEZ -->
{% if cliente_selecionado %}
<div id="modalAlocacao" class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4">
  <div class="bg-white rounded-2xl shadow-2xl max-w-md w-full p-6">
    <!-- Header -->
    <div class="flex items-center justify-between mb-6">
      <div class="flex items-center gap-3">
        <div class="w-10 h-10 bg-purple-100 rounded-xl flex items-center justify-center">
          <span class="text-xl">üí∞</span>
        </div>
        <div>
          <h2 class="text-xl font-bold text-gray-800">Criar Aloca√ß√£o</h2>
          <p class="text-sm text-gray-600">A partir do Mapa de Liquidez</p>
        </div>
      </div>
      <button onclick="fecharModalAlocacao()" class="text-gray-400 hover:text-gray-600">
        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
        </svg>
      </button>
    </div>

    <!-- Formul√°rio -->
    <form id="formAlocacao" onsubmit="criarAlocacao(event)">
      <input type="hidden" id="clienteCodigoInput" name="cliente_codigo" value="{{ cliente_selecionado }}">

      <!-- Informa√ß√£o do Fundo -->
      <div class="mb-4 p-4 bg-cyan-50 rounded-lg border border-cyan-200">
        <p class="text-xs font-medium text-cyan-700 mb-1">Resgatar de:</p>
        <p id="nomeFundoDisplay" class="text-sm font-bold text-gray-800"></p>
        <p class="text-xs text-gray-600 mt-1">Dispon√≠vel: <span id="valorDisponivelDisplay" class="font-bold text-cyan-600"></span></p>
      </div>

      <!-- Valor a Aplicar -->
      <div class="mb-4">
        <div class="flex items-center justify-between mb-2">
          <label for="valorInput" class="block text-sm font-medium text-gray-700">
            üíµ Valor a Aplicar
          </label>
          <label class="flex items-center gap-2 cursor-pointer">
            <input type="checkbox" id="checkboxTotal" onchange="aplicarValorTotal()"
                   class="w-4 h-4 text-purple-600 border-gray-300 rounded focus:ring-purple-500">
            <span class="text-sm font-bold text-purple-700">TOTAL</span>
          </label>
        </div>
        <div class="relative">
          <span class="absolute left-3 top-1/2 -translate-y-1/2 text-gray-500 font-medium">R$</span>
          <input type="number" id="valorInput" name="valor" step="0.01" min="0.01" required
                 class="w-full pl-10 pr-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500 font-mono"
                 placeholder="0,00">
        </div>
        <p class="text-xs text-gray-500 mt-1">M√°ximo: <span id="valorMaximo" class="font-bold"></span></p>
      </div>

      <!-- Produto Destino -->
      <div class="mb-6">
        <label for="produtoSelect" class="block text-sm font-medium text-gray-700 mb-2">
          üéØ Produto Destino
        </label>
        <select id="produtoSelect" name="produto_id" required
                class="w-full px-4 py-2.5 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-purple-500">
          <option value="">-- Selecione o produto --</option>
        </select>
      </div>

      <!-- Bot√µes -->
      <div class="flex gap-3">
        <button type="button" onclick="fecharModalAlocacao()"
                class="flex-1 px-4 py-2.5 border border-gray-300 text-gray-700 rounded-lg hover:bg-gray-50 font-medium transition-colors">
          Cancelar
        </button>
        <button type="submit"
                class="flex-1 px-4 py-2.5 bg-purple-600 text-white rounded-lg hover:bg-purple-700 font-bold transition-colors shadow-lg">
          ‚úÖ Criar Aloca√ß√£o
        </button>
      </div>
    </form>
  </div>
</div>
{% endif %}

<!-- Chart.js Script -->
{% if cliente_selecionado and (exposicao_rf or (exposicao_por_tipo and exposicao_por_tipo.total_geral > 0)) %}
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<script>
  // Fun√ß√£o para formatar valores no padr√£o brasileiro
  function formatarValorBR(valor) {
    return valor.toLocaleString('pt-BR', {
      minimumFractionDigits: 2,
      maximumFractionDigits: 2
    });
  }

  document.addEventListener('DOMContentLoaded', function() {
    // Gr√°fico de Rosca - Exposi√ß√£o Geral
    const ctx = document.getElementById('chartExposicaoGeral');
    if (ctx) {
      {% if exposicao_rf and exposicao_rf.total_rf and exposicao_rf.total_rf > 0 %}
      // Gr√°fico por Classe de Indexador (quando h√° dados de custodia_rf)
      const data = {
        labels: ['P√≥s-fixado', 'Prefixado', 'Infla√ß√£o', 'Internacional'],
        datasets: [{
          data: [
            {{ exposicao_rf.pos_fixado.percentual }},
            {{ exposicao_rf.pre_fixado.percentual }},
            {{ exposicao_rf.inflacao.percentual }},
            {{ exposicao_rf.internacional.percentual }}
          ],
          backgroundColor: [
            'rgb(59, 130, 246)',    // Blue-500 (P√≥s-fixado)
            'rgb(168, 85, 247)',    // Purple-500 (Prefixado)
            'rgb(249, 115, 22)',    // Orange-500 (Infla√ß√£o)
            'rgb(20, 184, 166)'     // Teal-500 (Internacional)
          ],
          borderColor: [
            'rgb(37, 99, 235)',     // Blue-600
            'rgb(147, 51, 234)',    // Purple-600
            'rgb(234, 88, 12)',     // Orange-600
            'rgb(13, 148, 136)'     // Teal-600
          ],
          borderWidth: 2,
          hoverOffset: 15
        }]
      };
      {% else %}
      // Gr√°fico por Tipo de Ativo (fallback - dados do diversificador)
      const data = {
        labels: ['Emiss√£o Banc√°ria', 'Cr√©dito Privado', 'T√≠tulo P√∫blico'],
        datasets: [{
          data: [
            {{ exposicao_por_tipo.emissao_bancaria.percentual }},
            {{ exposicao_por_tipo.credito_privado.percentual }},
            {{ exposicao_por_tipo.titulo_publico.percentual }}
          ],
          backgroundColor: [
            'rgb(59, 130, 246)',    // Blue-500
            'rgb(168, 85, 247)',    // Purple-500
            'rgb(34, 197, 94)'      // Green-500
          ],
          borderColor: [
            'rgb(37, 99, 235)',     // Blue-600
            'rgb(147, 51, 234)',    // Purple-600
            'rgb(22, 163, 74)'      // Green-600
          ],
          borderWidth: 2,
          hoverOffset: 15
        }]
      };
      {% endif %}

      const config = {
        type: 'doughnut',
        data: data,
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const label = context.label || '';
                  const value = context.parsed || 0;
                  return label + ': ' + value.toFixed(1) + '%';
                }
              },
              backgroundColor: 'rgba(0, 0, 0, 0.8)',
              titleColor: 'white',
              bodyColor: 'white',
              padding: 12,
              cornerRadius: 8,
              displayColors: true
            }
          },
          cutout: '65%',
          animation: {
            animateRotate: true,
            animateScale: true,
            duration: 1000,
            easing: 'easeInOutQuart'
          }
        }
      };

      new Chart(ctx, config);
    }

    // Gr√°fico de Barras - Vencimentos
    const ctxVenc = document.getElementById('chartVencimentos');
    if (ctxVenc) {
      {% if credito_privado_vencimentos %}
      const vencimentosData = {
        labels: [
          {% for venc in credito_privado_vencimentos %}
          '{{ venc.label }}'{% if not loop.last %},{% endif %}
          {% endfor %}
        ],
        datasets: [{
          label: 'Valor (R$)',
          data: [
            {% for venc in credito_privado_vencimentos %}
            {{ venc.total }}{% if not loop.last %},{% endif %}
            {% endfor %}
          ],
          backgroundColor: 'rgba(168, 85, 247, 0.8)',  // Purple-500
          borderColor: 'rgb(147, 51, 234)',             // Purple-600
          borderWidth: 2,
          borderRadius: 8,
          hoverBackgroundColor: 'rgba(147, 51, 234, 0.9)'
        }]
      };

      const vencimentosConfig = {
        type: 'bar',
        data: vencimentosData,
        options: {
          responsive: true,
          maintainAspectRatio: true,
          indexAxis: 'y',  // Barras horizontais
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const value = context.parsed.x || 0;
                  return 'R$ ' + formatarValorBR(value);
                }
              },
              backgroundColor: 'rgba(0, 0, 0, 0.8)',
              titleColor: 'white',
              bodyColor: 'white',
              padding: 12,
              cornerRadius: 8
            }
          },
          scales: {
            x: {
              beginAtZero: true,
              ticks: {
                callback: function(value) {
                  return 'R$ ' + (value / 1000).toFixed(0) + 'k';
                },
                font: {
                  size: 11
                }
              },
              grid: {
                color: 'rgba(0, 0, 0, 0.05)'
              }
            },
            y: {
              ticks: {
                font: {
                  size: 11,
                  weight: '500'
                }
              },
              grid: {
                display: false
              }
            }
          },
          animation: {
            duration: 1000,
            easing: 'easeInOutQuart'
          }
        }
      };

      new Chart(ctxVenc, vencimentosConfig);
      {% endif %}
    }

    // Gr√°fico de Exposi√ß√£o RF por Indexador
    const ctxIndexadores = document.getElementById('chartExposicaoIndexadores');
    if (ctxIndexadores) {
      {% if exposicao_rf and exposicao_rf.total_rf and exposicao_rf.total_rf > 0 %}
      const indexadoresData = {
        labels: ['P√≥s-fixado', 'Prefixado', 'Infla√ß√£o', 'Internacional'],
        datasets: [{
          data: [
            {{ exposicao_rf.pos_fixado.percentual }},
            {{ exposicao_rf.pre_fixado.percentual }},
            {{ exposicao_rf.inflacao.percentual }},
            {{ exposicao_rf.internacional.percentual }}
          ],
          backgroundColor: [
            'rgba(59, 130, 246, 0.85)',     // Blue-500 (P√≥s-fixado)
            'rgba(168, 85, 247, 0.85)',     // Purple-500 (Prefixado)
            'rgba(249, 115, 22, 0.85)',     // Orange-500 (Infla√ß√£o)
            'rgba(20, 184, 166, 0.85)'      // Teal-500 (Internacional)
          ],
          borderColor: [
            'rgb(37, 99, 235)',             // Blue-600
            'rgb(147, 51, 234)',            // Purple-600
            'rgb(234, 88, 12)',             // Orange-600
            'rgb(13, 148, 136)'             // Teal-600
          ],
          borderWidth: 3,
          hoverOffset: 20,
          hoverBorderWidth: 4
        }]
      };

      const indexadoresConfig = {
        type: 'doughnut',
        data: indexadoresData,
        options: {
          responsive: true,
          maintainAspectRatio: true,
          plugins: {
            legend: {
              display: false
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  const label = context.label || '';
                  const value = context.parsed || 0;
                  const total = {{ exposicao_rf.total_rf }};
                  const indexValues = [
                    {{ exposicao_rf.pos_fixado.total }},
                    {{ exposicao_rf.pre_fixado.total }},
                    {{ exposicao_rf.inflacao.total }},
                    {{ exposicao_rf.internacional.total }}
                  ];
                  const valorAbsoluto = indexValues[context.dataIndex];
                  return [
                    label + ': ' + value.toFixed(1) + '%',
                    'R$ ' + formatarValorBR(valorAbsoluto)
                  ];
                }
              },
              backgroundColor: 'rgba(0, 0, 0, 0.85)',
              titleColor: 'white',
              bodyColor: 'white',
              padding: 14,
              cornerRadius: 10,
              displayColors: true,
              boxWidth: 12,
              boxHeight: 12,
              bodyFont: {
                size: 13
              },
              titleFont: {
                size: 14,
                weight: 'bold'
              }
            }
          },
          cutout: '60%',
          animation: {
            animateRotate: true,
            animateScale: true,
            duration: 1200,
            easing: 'easeInOutQuart'
          }
        }
      };

      new Chart(ctxIndexadores, indexadoresConfig);
      {% endif %}
    }
  });
</script>
{% endif %}

<!-- üî• SCRIPT DO MODAL DE ALOCA√á√ÉO -->
{% if cliente_selecionado %}
<script>
  let valorMaximoGlobal = 0;
  let produtosCarregados = false;

  // Buscar produtos dispon√≠veis ao carregar a p√°gina
  document.addEventListener('DOMContentLoaded', function() {
    carregarProdutos();
  });

  async function carregarProdutos() {
    try {
      const response = await fetch('{{ url_for("alocacoes.produtos") }}');
      if (!response.ok) throw new Error('Erro ao carregar produtos');

      const html = await response.text();
      const parser = new DOMParser();
      const doc = parser.parseFromString(html, 'text/html');

      // Extrair produtos da tabela (adaptar conforme estrutura da p√°gina)
      const produtoSelect = document.getElementById('produtoSelect');
      produtoSelect.innerHTML = '<option value="">-- Selecione o produto --</option>';

      // Fazer requisi√ß√£o para obter dados JSON dos produtos
      const respProdutos = await fetch('{{ url_for("alocacoes.produtos") }}');

      // Como n√£o temos endpoint JSON, vamos precisar parsear o HTML ou criar um endpoint
      // Por enquanto, vamos adicionar op√ß√µes manualmente via servidor
      // O ideal seria ter um endpoint /alocacoes/produtos/json

      produtosCarregados = true;
    } catch (error) {
      console.error('Erro ao carregar produtos:', error);
    }
  }

  function abrirModalAlocacao(nomeFundo, valorDisponivel, cnpjFundo) {
    const modal = document.getElementById('modalAlocacao');
    const nomeFundoDisplay = document.getElementById('nomeFundoDisplay');
    const valorDisponivelDisplay = document.getElementById('valorDisponivelDisplay');
    const valorMaximo = document.getElementById('valorMaximo');
    const valorInput = document.getElementById('valorInput');

    nomeFundoDisplay.textContent = nomeFundo;
    valorDisponivelDisplay.textContent = formatarMoeda(valorDisponivel);
    valorMaximo.textContent = formatarMoeda(valorDisponivel);
    valorInput.max = valorDisponivel;
    valorMaximoGlobal = valorDisponivel;

    // Carregar produtos dinamicamente
    carregarProdutosParaSelect();

    modal.classList.remove('hidden');
  }

  function fecharModalAlocacao() {
    const modal = document.getElementById('modalAlocacao');
    modal.classList.add('hidden');
    document.getElementById('formAlocacao').reset();
    // Limpar tamb√©m o checkbox
    document.getElementById('checkboxTotal').checked = false;
  }

  function aplicarValorTotal() {
    const checkbox = document.getElementById('checkboxTotal');
    const valorInput = document.getElementById('valorInput');

    if (checkbox.checked) {
      // Preencher com o valor m√°ximo dispon√≠vel
      valorInput.value = valorMaximoGlobal.toFixed(2);
    } else {
      // Limpar o campo quando desmarcar
      valorInput.value = '';
    }
  }

  async function carregarProdutosParaSelect() {
    const produtoSelect = document.getElementById('produtoSelect');
    produtoSelect.innerHTML = '<option value="">Carregando...</option>';

    try {
      const response = await fetch('{{ url_for("alocacoes.produtos_json") }}');
      if (!response.ok) throw new Error('Erro ao carregar produtos');

      const produtos = await response.json();

      produtoSelect.innerHTML = '<option value="">-- Selecione o produto --</option>';

      produtos.forEach(produto => {
        const option = document.createElement('option');
        option.value = produto.id;
        option.textContent = `${produto.nome} (${produto.classe})`;
        produtoSelect.appendChild(option);
      });

    } catch (error) {
      console.error('Erro ao carregar produtos:', error);
      produtoSelect.innerHTML = '<option value="">Erro ao carregar produtos</option>';
    }
  }

  async function criarAlocacao(event) {
    event.preventDefault();

    const form = event.target;
    const formData = new FormData(form);
    const valor = parseFloat(formData.get('valor'));

    // Validar valor m√°ximo
    if (valor > valorMaximoGlobal) {
      alert(`Valor n√£o pode ser maior que R$ ${formatarMoeda(valorMaximoGlobal)}`);
      return;
    }

    const submitBtn = form.querySelector('button[type="submit"]');
    const originalText = submitBtn.innerHTML;
    submitBtn.disabled = true;
    submitBtn.innerHTML = '‚è≥ Criando...';

    try {
      const response = await fetch('{{ url_for("clientes.criar_alocacao_liquidez") }}', {
        method: 'POST',
        body: formData
      });

      const result = await response.json();

      if (result.success) {
        alert(result.message);
        fecharModalAlocacao();
        // Redirecionar para tela de aloca√ß√µes
        window.location.href = '{{ url_for("alocacoes.index") }}';
      } else {
        alert('Erro: ' + result.message);
      }
    } catch (error) {
      console.error('Erro ao criar aloca√ß√£o:', error);
      alert('Erro ao criar aloca√ß√£o. Tente novamente.');
    } finally {
      submitBtn.disabled = false;
      submitBtn.innerHTML = originalText;
    }
  }

  function formatarMoeda(valor) {
    return new Intl.NumberFormat('pt-BR', {
      style: 'currency',
      currency: 'BRL'
    }).format(valor);
  }

  // Fechar modal ao clicar fora
  document.addEventListener('click', function(event) {
    const modal = document.getElementById('modalAlocacao');
    if (event.target === modal) {
      fecharModalAlocacao();
    }
  });
</script>
{% endif %}

<!-- Script de filtro alfab√©tico (sempre dispon√≠vel quando h√° clientes) -->
{% if clientes %}
<script>
  // Fun√ß√£o para filtrar clientes por letra
  function filtrarPorLetra(letra) {
    const select = document.getElementById('selectCliente');
    const options = select.querySelectorAll('option');

    // Atualizar estilos dos bot√µes
    const botoes = document.querySelectorAll('.filtro-letra');
    botoes.forEach(btn => {
      const btnLetra = btn.getAttribute('data-letra');
      if (btnLetra === letra) {
        btn.className = 'filtro-letra px-3 py-1.5 text-sm font-medium rounded-lg border-2 transition-all duration-200 border-purple-600 bg-purple-600 text-white hover:bg-purple-700';
      } else {
        btn.className = 'filtro-letra px-3 py-1.5 text-sm font-medium rounded-lg border-2 transition-all duration-200 border-gray-300 bg-white text-gray-700 hover:border-purple-400 hover:bg-purple-50';
      }
    });

    // Filtrar op√ß√µes
    let primeiraOpcaoVisivel = null;
    options.forEach((option, index) => {
      if (index === 0) {
        // Manter a op√ß√£o "-- Selecione um cliente --"
        option.style.display = '';
        return;
      }

      const nome = option.getAttribute('data-nome');
      if (!nome) return;

      const primeiraLetra = nome.charAt(0).toUpperCase();

      if (letra === '' || primeiraLetra === letra) {
        option.style.display = '';
        if (!primeiraOpcaoVisivel) {
          primeiraOpcaoVisivel = option;
        }
      } else {
        option.style.display = 'none';
      }
    });

    // Resetar sele√ß√£o para a op√ß√£o padr√£o
    select.value = '';
  }
</script>
{% endif %}

{% endblock %}
